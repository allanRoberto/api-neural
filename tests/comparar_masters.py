"""
tests/comparar_masters.py

Compara MASTER original vs MASTER melhorado
"""

import sys
import os
import asyncio

sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from motor.motor_asyncio import AsyncIOMotorClient
from config.settings import Settings
from patterns.master import MasterPattern
from patterns.master_melhorado import MasterPatternMelhorado


async def comparar():
    """Compara os dois MASTERS"""
    
    print("\n" + "="*70)
    print("‚öîÔ∏è  MASTER ORIGINAL vs MASTER MELHORADO")
    print("="*70)
    
    # Conectar
    settings = Settings()
    client = AsyncIOMotorClient(settings.mongodb_url)
    db = client[settings.MONGODB_DATABASE]
    collection = db[settings.MONGODB_COLLECTION]
    
    # Buscar hist√≥rico
    print("\nüìä Buscando hist√≥rico...")
    cursor = collection.find(
        {"roulette_id": "pragmatic-brazilian-roulette"}
    ).sort("timestamp", -1).limit(500)
    
    documents = await cursor.to_list(length=500)
    historico = [doc.get("value", 0) for doc in documents]
    
    print(f"‚úÖ {len(historico)} n√∫meros carregados")
    print(f"√öltimos 10: {historico[:10]}\n")
    
    # Config padr√£o
    config = {
        "janela_min": 2,
        "janela_max": 3,
        "decay_factor": 0.95,
        "min_support": 2,
    }
    
    # MASTER ORIGINAL
    print("="*70)
    print("üî∑ MASTER ORIGINAL")
    print("="*70)
    
    master_original = MasterPattern(config=config)
    resultado_original = master_original.analyze(historico)
    
    print(f"\nPar√¢metros: {config}")
    print(f"Padr√µes encontrados: {resultado_original.metadata.get('padroes_encontrados', 0)}")
    print(f"Janelas analisadas: {resultado_original.metadata.get('janelas_analisadas', 0)}")
    print(f"\nTop 10:")
    
    for i, (num, score) in enumerate(resultado_original.get_top_n(10), 1):
        print(f"  {i:2d}. N√∫mero {num:2d}: {score:.6f}")
    
    # MASTER MELHORADO
    print("\n" + "="*70)
    print("üî∂ MASTER MELHORADO")
    print("="*70)
    
    master_melhorado = MasterPatternMelhorado(config=config)
    resultado_melhorado = master_melhorado.analyze(historico)
    
    print(f"\nPar√¢metros: {config}")
    print(f"Padr√µes encontrados: {resultado_melhorado.metadata.get('padroes_encontrados', 0)}")
    print(f"Janelas analisadas: {resultado_melhorado.metadata.get('janelas_analisadas', 0)}")
    print(f"Modo: {resultado_melhorado.metadata.get('modo', 'normal')}")
    print(f"\nTop 10:")
    
    for i, (num, score) in enumerate(resultado_melhorado.get_top_n(10), 1):
        print(f"  {i:2d}. N√∫mero {num:2d}: {score:.6f}")
    
    # COMPARA√á√ÉO
    print("\n" + "="*70)
    print("üìä COMPARA√á√ÉO")
    print("="*70)
    
    top_orig = [num for num, _ in resultado_original.get_top_n(10)]
    top_mel = [num for num, _ in resultado_melhorado.get_top_n(10)]
    
    if top_orig == top_mel:
        print("\n‚ö†Ô∏è  Os Top 10 s√£o ID√äNTICOS")
    else:
        print("\n‚úÖ Os Top 10 s√£o DIFERENTES")
        print(f"\nOriginal:  {top_orig}")
        print(f"Melhorado: {top_mel}")
        
        # Quantos s√£o diferentes
        diferentes = len(set(top_orig) - set(top_mel))
        print(f"\nN√∫meros diferentes: {diferentes}/10")
    
    # Teste com min_support=1
    print("\n\n" + "="*70)
    print("üî∂ MASTER MELHORADO (min_support=1)")
    print("="*70)
    
    config_sensivel = config.copy()
    config_sensivel['min_support'] = 1
    
    master_sensivel = MasterPatternMelhorado(config=config_sensivel)
    resultado_sensivel = master_sensivel.analyze(historico)
    
    print(f"\nPar√¢metros: {config_sensivel}")
    print(f"Padr√µes encontrados: {resultado_sensivel.metadata.get('padroes_encontrados', 0)}")
    print(f"Janelas analisadas: {resultado_sensivel.metadata.get('janelas_analisadas', 0)}")
    print(f"Modo: {resultado_sensivel.metadata.get('modo', 'normal')}")
    print(f"\nTop 10:")
    
    for i, (num, score) in enumerate(resultado_sensivel.get_top_n(10), 1):
        print(f"  {i:2d}. N√∫mero {num:2d}: {score:.6f}")
    
    top_sens = [num for num, _ in resultado_sensivel.get_top_n(10)]
    
    if top_sens != top_mel:
        print(f"\n‚úÖ DIFERENTE do melhorado padr√£o!")
        print(f"N√∫meros diferentes: {len(set(top_sens) - set(top_mel))}/10")
    
    client.close()


if __name__ == "__main__":
    asyncio.run(comparar())